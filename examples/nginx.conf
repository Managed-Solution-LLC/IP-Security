# nginx IP Blocking Configuration Example
# Description: Example configuration for blocking IPs in nginx
# Usage: Include this file in your nginx configuration

# Define a geo block for malicious IPs
geo $malicious_ip {
    default 0;
    
    # Malware sources - use 1 to mark as malicious
    192.0.2.10 1;
    192.0.2.11 1;
    192.0.2.12 1;
    
    # Botnet sources
    192.0.2.50 1;
    192.0.2.51 1;
    
    # Abuse sources
    192.0.2.200 1;
    192.0.2.201 1;
    
    # You can also include CIDR ranges
    192.0.2.0/29 1;
    198.51.100.0/24 1;
}

# Alternative: Using map for more complex rules
map $remote_addr $blocked_ip {
    default 0;
    
    # Include blocklists
    192.0.2.10 1;
    192.0.2.11 1;
    192.0.2.50 1;
    
    # CIDR notation
    ~^192\.0\.2\. 1;  # Block entire range with regex
}

# ===================================================================
# IMPORTANT: Rate limiting must be configured in http context
# Place this section in your main nginx.conf http block, NOT in server block
# ===================================================================
limit_req_zone $binary_remote_addr zone=general:10m rate=10r/s;

# Server block example
server {
    listen 80;
    server_name example.com;
    
    # Block malicious IPs
    if ($malicious_ip) {
        return 403 "Access Denied - IP Blocked for Security Reasons";
    }
    
    # Alternative using map
    if ($blocked_ip) {
        return 403;
    }
    
    # Apply rate limiting (references the zone defined in http context above)
    limit_req zone=general burst=20 nodelay;
    
    # Your normal location blocks
    location / {
        root /var/www/html;
        index index.html;
    }
    
    # Log blocked requests
    error_log /var/log/nginx/blocked_ips.log notice;
}

# Advanced: Include external file
# 1. Convert blocklist to nginx format:
# sed 's/^/    /; s/$/ 1;/' blocklists/malware.txt > /etc/nginx/blocklist.conf
#
# 2. Include in geo block:
# geo $blocked_ip {
#     default 0;
#     include /etc/nginx/blocklist.conf;
# }

# Best Practices:
# 1. Use geo module for large IP lists (more efficient than if conditions)
# 2. Reload nginx after updating: nginx -s reload
# 3. Test configuration before reload: nginx -t
# 4. Monitor logs for false positives
# 5. Implement rate limiting as additional layer

# Performance Note:
# For very large lists (10,000+ IPs), consider:
# - Using nginx plus with dynamic modules
# - Implementing at firewall level (iptables/nftables)
# - Using a WAF service (Cloudflare, etc.)
