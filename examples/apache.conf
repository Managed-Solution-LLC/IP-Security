# Apache IP Blocking Configuration Example
# Description: Example configuration for blocking IPs in Apache
# Usage: Include in httpd.conf, VirtualHost, or .htaccess

# Method 1: Using Require directive (Apache 2.4+)
<RequireAll>
    Require all granted
    
    # Block individual IPs
    Require not ip 192.0.2.10
    Require not ip 192.0.2.11
    Require not ip 192.0.2.12
    
    # Block CIDR ranges
    Require not ip 192.0.2.0/29
    Require not ip 198.51.100.0/24
    
    # Block IPv6
    Require not ip 2001:db8:1::10
</RequireAll>

# Method 2: Using SetEnvIf and Deny
<IfModule mod_setenvif.c>
    # Set environment variable for blocked IPs
    SetEnvIf Remote_Addr "^192\.0\.2\.10$" BlockedIP
    SetEnvIf Remote_Addr "^192\.0\.2\.11$" BlockedIP
    SetEnvIf Remote_Addr "^192\.0\.2\.50$" BlockedIP
    SetEnvIf Remote_Addr "^192\.0\.2\." BlockedIP
    
    # Deny access for blocked IPs
    <RequireAll>
        Require all granted
        Require not env BlockedIP
    </RequireAll>
</IfModule>

# Method 3: Using RewriteEngine (Apache 2.x)
<IfModule mod_rewrite.c>
    RewriteEngine On
    
    # Block specific IPs
    RewriteCond %{REMOTE_ADDR} ^192\.0\.2\.10$ [OR]
    RewriteCond %{REMOTE_ADDR} ^192\.0\.2\.11$ [OR]
    RewriteCond %{REMOTE_ADDR} ^192\.0\.2\.50$
    RewriteRule ^ - [F,L]
    
    # Block CIDR range using regex
    RewriteCond %{REMOTE_ADDR} ^192\.0\.2\.
    RewriteRule ^ - [F,L]
</IfModule>

# Method 4: External file inclusion
# Create a file /etc/apache2/blocklist.conf with:
# Require not ip 192.0.2.10
# Require not ip 192.0.2.11
# Then include it:
# Include /etc/apache2/blocklist.conf

# VirtualHost Example
<VirtualHost *:80>
    ServerName example.com
    DocumentRoot /var/www/html
    
    <Directory /var/www/html>
        Options -Indexes +FollowSymLinks
        AllowOverride None
        
        <RequireAll>
            Require all granted
            
            # Include blocklist
            Require not ip 192.0.2.10
            Require not ip 192.0.2.11
            Require not ip 192.0.2.50
            Require not ip 192.0.2.0/29
        </RequireAll>
    </Directory>
    
    # Custom error page for blocked IPs
    ErrorDocument 403 "Access Denied - IP Blocked for Security Reasons"
    
    # Logging
    CustomLog ${APACHE_LOG_DIR}/access.log combined
    ErrorLog ${APACHE_LOG_DIR}/error.log
</VirtualHost>

# .htaccess Example (if AllowOverride is enabled)
# Place in document root or specific directory
<IfModule mod_authz_core.c>
    <RequireAll>
        Require all granted
        Require not ip 192.0.2.10
        Require not ip 192.0.2.11
        Require not ip 192.0.2.0/24
    </RequireAll>
</IfModule>

# For Apache 2.2 (legacy)
<IfModule !mod_authz_core.c>
    Order Allow,Deny
    Allow from all
    Deny from 192.0.2.10
    Deny from 192.0.2.11
    Deny from 192.0.2.0/24
</IfModule>

# Rate Limiting (mod_ratelimit)
<IfModule mod_ratelimit.c>
    <Location />
        # Limit to 400 KB/s per connection
        SetOutputFilter RATE_LIMIT
        SetEnv rate-limit 400
    </Location>
</IfModule>

# Security Headers
<IfModule mod_headers.c>
    Header set X-Frame-Options "SAMEORIGIN"
    Header set X-Content-Type-Options "nosniff"
    Header set Content-Security-Policy "default-src 'self'"
</IfModule>

# Best Practices:
# 1. Test configuration: apachectl configtest
# 2. Reload after changes: systemctl reload apache2
# 3. Monitor error logs for blocked requests
# 4. Use Require directive for Apache 2.4+
# 5. Consider mod_security for advanced WAF features
# 6. Implement at multiple layers (firewall + application)

# Performance Considerations:
# - Large IP lists may impact performance
# - Consider using mod_security with SecRule
# - For 10,000+ IPs, use firewall-level blocking
# - Cache configuration in memory where possible

# Automated Updates:
# Create a script to convert blocklists to Apache format:
# #!/bin/bash
# echo "<RequireAll>" > /etc/apache2/blocklist.conf
# echo "    Require all granted" >> /etc/apache2/blocklist.conf
# while read ip; do
#     [[ "$ip" =~ ^#.*$ ]] && continue
#     [[ -z "$ip" ]] && continue
#     echo "    Require not ip $ip" >> /etc/apache2/blocklist.conf
# done < blocklists/malware.txt
# echo "</RequireAll>" >> /etc/apache2/blocklist.conf
# apachectl configtest && systemctl reload apache2
